<?xml version="1.0"?>
<robot name="my_robot">
  <!-- 新增：虚拟根链接（解决KDL惯性警告的核心） -->
  <link name="world_link">
    <!-- 虚拟链接无需惯性、碰撞或视觉属性，仅作为根节点 -->
  </link>

  <!-- 新增：连接虚拟根链接与base_link的固定关节 -->
  <joint name="world_to_base_joint" type="fixed">
    <parent link="world_link"/>  <!-- 父链接：虚拟根节点 -->
    <child link="base_link"/>    <!-- 子链接：原基础链接 -->
    <origin xyz="0 0 0" rpy="0 0 0"/>  <!-- 初始位置重合，不改变机器人姿态 -->
  </joint>

  <!-- 基础链接（原base_link，现在作为world_link的子链接） -->
  <link name="base_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder length="0.1" radius="0.2"/>  <!-- 圆形底座，半径0.2m，高度0.1m -->
      </geometry>
      <material name="blue">
        <color rgba="0 0 0.8 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder length="0.1" radius="0.2"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="10"/>
      <inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1"/>
    </inertial>
  </link>

  <!-- 虚拟轴链接（用于绑定前后轮） -->
  <link name="left_axis">
    <inertial>
      <mass value="0.1"/>
      <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
    </inertial>
  </link>
  
  <link name="right_axis">
    <inertial>
      <mass value="0.1"/>
      <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
    </inertial>
  </link>

  <!-- 轮子链接（保持不变） -->
  <link name="wheel_front_left">
    <visual>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder length="0.05" radius="0.05"/>
      </geometry>
      <material name="black">
        <color rgba="0 0 0 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder length="0.05" radius="0.05"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="1"/>
      <inertia ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1"/>
    </inertial>
  </link>

  <link name="wheel_front_right">
    <visual>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder length="0.05" radius="0.05"/>
      </geometry>
      <material name="black"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder length="0.05" radius="0.05"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="1"/>
      <inertia ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1"/>
    </inertial>
  </link>

  <link name="wheel_back_left">
    <visual>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder length="0.05" radius="0.05"/>
      </geometry>
      <material name="black"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder length="0.05" radius="0.05"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="1"/>
      <inertia ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1"/>
    </inertial>
  </link>

  <link name="wheel_back_right">
    <visual>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder length="0.05" radius="0.05"/>
      </geometry>
      <material name="black"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="1.5708 0 0"/>
      <geometry>
        <cylinder length="0.05" radius="0.05"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="1"/>
      <inertia ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1"/>
    </inertial>
  </link>

  <!-- 激光雷达（保持不变） -->
  <link name="laser_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder length="0.1" radius="0.05"/>
      </geometry>
      <material name="red">
        <color rgba="0.8 0 0 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder length="0.1" radius="0.05"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="0.5"/>
      <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
    </inertial>
  </link>

  <!-- 关节连接（保持不变） -->
  <!-- 虚拟轴与底座的连接 -->
  <joint name="left_axis_joint" type="fixed">
    <parent link="base_link"/>
    <child link="left_axis"/>
    <origin xyz="0 0.2 0" rpy="0 0 0"/> <!-- 左轮轴位于底座右侧（Y=0.2） -->
  </joint>
  
  <joint name="right_axis_joint" type="fixed">
    <parent link="base_link"/>
    <child link="right_axis"/>
    <origin xyz="0 -0.2 0" rpy="0 0 0"/> <!-- 右轮轴位于底座左侧（Y=-0.2） -->
  </joint>

  <!-- 轮子与虚拟轴的连接 -->
  <joint name="joint_front_left" type="continuous">
    <parent link="left_axis"/>
    <child link="wheel_front_left"/>
    <origin xyz="0.15 0 -0.05" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
    <limit effort="100" velocity="100"/>
    <joint_properties damping="1.0" friction="1.0"/>
  </joint>

  <joint name="joint_front_right" type="continuous">
    <parent link="right_axis"/>
    <child link="wheel_front_right"/>
    <origin xyz="0.15 0 -0.05" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
    <limit effort="100" velocity="100"/>
    <joint_properties damping="1.0" friction="1.0"/>
  </joint>

  <joint name="joint_back_left" type="continuous">
    <parent link="left_axis"/>
    <child link="wheel_back_left"/>
    <origin xyz="-0.15 0 -0.05" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
    <limit effort="100" velocity="100"/>
    <joint_properties damping="1.0" friction="1.0"/>
  </joint>

  <joint name="joint_back_right" type="continuous">
    <parent link="right_axis"/>
    <child link="wheel_back_right"/>
    <origin xyz="-0.15 0 -0.05" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
    <limit effort="100" velocity="100"/>
    <joint_properties damping="1.0" friction="1.0"/>
  </joint>

  <joint name="joint_laser" type="fixed">
    <parent link="base_link"/>
    <child link="laser_link"/>
    <origin xyz="0 0 0.1" rpy="0 0 0"/>
  </joint>

  <!-- Gazebo插件（保持你之前的优化） -->
   <gazebo>
    <plugin name="differential_drive_controller" filename="libgazebo_ros_diff_drive.so">
      <rosDebugLevel>Debug</rosDebugLevel>
      <publishWheelTF>false</publishWheelTF>
      <publishOdomTF>true</publishOdomTF>
      <odometrySource>world</odometrySource>
      <robotNamespace>/</robotNamespace>
      <publishTf>1</publishTf>
      <publishWheelJointState>true</publishWheelJointState>
      <alwaysOn>true</alwaysOn>
      <updateRate>10.0</updateRate>  <!-- 已降低频率，避免TF重复 -->
      
      <leftJoint>joint_front_left</leftJoint>
      <rightJoint>joint_front_right</rightJoint>
      
      <wheelSeparation>0.4</wheelSeparation>
      <wheelDiameter>0.1</wheelDiameter>
      <wheelTorque>30</wheelTorque>
      <wheelAcceleration>1.8</wheelAcceleration>
      <commandTopic>cmd_vel</commandTopic>
      <odometryFrame>odom</odometryFrame>
      <robotBaseFrame>base_link</robotBaseFrame>
      <odometryTopic>odom</odometryTopic>
      <tfPrefix></tfPrefix>
      <odometrySource>encoders</odometrySource>
      <tfPublishFrequency>10.0</tfPublishFrequency>
    </plugin>
  </gazebo>


  <!-- 激光雷达插件（保持不变） -->
  <gazebo reference="laser_link">
    <sensor type="ray" name="laser">
      <pose>0 0 0 0 0 0</pose>
      <visualize>true</visualize>
      <update_rate>30</update_rate>
      <ray>
        <scan>
          <horizontal>
            <samples>360</samples>
            <resolution>1</resolution>
            <min_angle>-3.14159265</min_angle>
            <max_angle>3.14159265</max_angle>
          </horizontal>
        </scan>
        <range>
          <min>0.1</min>
          <max>5.0</max>
          <resolution>0.01</resolution>
        </range>
        <noise>
          <type>gaussian</type>
          <mean>0.0</mean>
          <stddev>0.01</stddev>
        </noise>
      </ray>
      <plugin name="gazebo_ros_laser_controller" filename="libgazebo_ros_laser.so">
        <topicName>/scan</topicName>
        <frameName>laser_link</frameName>
      </plugin>
    </sensor>
  </gazebo>
</robot>
